{
  "version": 3,
  "sources": ["../src/authRepository.ts"],
  "sourcesContent": ["import axios, { AxiosError } from 'axios';\nimport * as fs from 'fs';\nimport jsonfile from 'jsonfile';\nimport * as session from './models/Session';\n\nexport default interface AuthOptions {\n    clientId: string;\n    clientSecret: string;\n    useAuthorizationCodeGrant: boolean;\n    redirectUri: string;\n    authCode: string;\n    sessionStoreFilePath: string;\n    baseUrl: string;\n    scope: string;\n    timeout: number;\n    userAgent: string;\n    renewBeforeExpiry: number;\n}\n\ninterface Session extends session.Session {\n    expires_at?: number;\n    authCode?: string;\n}\n\nexport class AuthRepository {\n    constructor(options: AuthOptions, log: ioBroker.Log) {\n        this.log = log;\n        this.options = options;\n\n        axios.defaults.baseURL = options.baseUrl;\n        axios.defaults.headers.common['user-agent'] = options.userAgent;\n        axios.defaults.timeout = options.timeout;\n\n        if (this.options.useAuthorizationCodeGrant) {\n            this.readSessionFromFile();\n            if (this.hasNewAuthCode()) {\n                this.setEmptySession();\n            }\n        }\n    }\n\n    private log: ioBroker.Log;\n    private options: AuthOptions;\n    private auth: Session | undefined;\n\n    async getAccessToken(): Promise<string | undefined> {\n        this.log.debug('Get access token');\n\n        if (!this.hasAccessToken()) {\n            if (this.options.useAuthorizationCodeGrant) {\n                if (this.options.authCode) {\n                    const token = await this.getAuthorizationCodeGrantToken(this.options.authCode);\n                    await this.setSesssion(token);\n                } else {\n                    this.log.error('You need to get and set a new Auth Code. You can do this in the adapter setting.');\n                    return undefined;\n                }\n            } else {\n                const token = await this.getClientCredentialsGrantToken();\n                await this.setSesssion(token);\n            }\n        }\n        if (this.isTokenExpired()) {\n            if (this.options.useAuthorizationCodeGrant) {\n                const token = await this.refreshToken();\n                await this.setSesssion(token);\n            } else {\n                const token = await this.getClientCredentialsGrantToken();\n                await this.setSesssion(token);\n            }\n        }\n\n        return this.auth?.access_token;\n    }\n\n    private async getAuthorizationCodeGrantToken(authCode: string): Promise<Session> {\n        this.log.debug('Get token via Authorization Code Grant Flow');\n        const data = {\n            grant_type: 'authorization_code',\n            client_id: this.options.clientId,\n            client_secret: this.options.clientSecret,\n            code: authCode,\n            redirect_uri: this.options.redirectUri,\n            scope: this.options.scope,\n        };\n        const session = await this.postTokenRequest(data);\n        this.log.debug(`Token received. Refresh Token received: ${session.refresh_token != undefined}. Access Token expires in: ${session.expires_in}`);\n        if (!session.refresh_token) {\n            this.log.warn('Receive Access Token without Refresh Token.');\n        }\n        return session;\n    }\n\n    private async getClientCredentialsGrantToken(): Promise<Session> {\n        this.log.debug('Get token via Client Credentials Grant Flow');\n        const data = {\n            grant_type: 'client_credentials',\n            client_id: this.options.clientId,\n            client_secret: this.options.clientSecret,\n            scope: this.options.scope,\n        };\n        const session = await this.postTokenRequest(data);\n        this.log.debug(`Token received. Refresh Token received: ${session.refresh_token != undefined}. Access Token expires in: ${session.expires_in}`);\n        return session;\n    }\n\n    private async refreshToken(): Promise<Session> {\n        if (!this.auth?.refresh_token) {\n            throw new Error('Cannot refresh the token because no refresh token is available.');\n        }\n\n        this.log.debug('Get token via Refresh Token Grant Flow');\n        const data = {\n            grant_type: 'refresh_token',\n            refresh_token: this.auth?.refresh_token,\n            client_id: this.options.clientId,\n            client_secret: this.options.clientSecret,\n        };\n        const session = await this.postTokenRequest(data);\n        this.log.debug(`Token received. Refresh Token received: ${session.refresh_token != undefined}. Access Token expires in: ${session.expires_in}`);\n        if (!session.refresh_token) {\n            this.log.warn('Receive Access Token without Refresh Token.');\n        }\n        return session;\n    }\n\n    private async postTokenRequest(body: any): Promise<Session> {\n        const stringBody = new URLSearchParams(body).toString();\n        const url = '/oauth/token';\n        try {\n            const { data } = await axios.post<Session>(url, stringBody, {\n                headers: {\n                    'Content-Type': 'application/x-www-form-urlencoded',\n                },\n            });\n            const expiresIn = data.expires_in ?? 1800;\n            data.expires_at = Date.now() + expiresIn * 1000;\n            this.log.silly(`TokenData: ${JSON.stringify(data, null, ' ')}`);\n            return data;\n        } catch (error) {\n            throw this.checkError(url, error);\n        }\n    }\n\n    private checkError(suburl: string, error: unknown): Error | unknown {\n        this.log.error(`error from ${suburl}`);\n        this.log.error(JSON.stringify(error, null, ' '));\n        if (axios.isAxiosError(error)) {\n            const axiosError = error as AxiosError;\n            if (axiosError.response != null) {\n                if (axiosError.response.status == 401) {\n                    this.setEmptySession();\n                }\n                if (axiosError.response.data != null) {\n                    const responseText = JSON.stringify(axiosError.response.data, null, ' ');\n                    const errorMessage = `${axiosError.response.statusText}: ${responseText}`;\n                    return new Error(errorMessage);\n                } else {\n                    return new Error(axiosError.response.statusText);\n                }\n            }\n        }\n        return error;\n    }\n\n    private readSessionFromFile(): void {\n        if (!this.options.sessionStoreFilePath || !fs.existsSync(this.options.sessionStoreFilePath)) {\n            return;\n        }\n        this.log.debug(`Read session from file '${this.options.sessionStoreFilePath}'`);\n        this.auth = jsonfile.readFileSync(this.options.sessionStoreFilePath, { throws: false });\n    }\n\n    private async setSesssion(auth: Session): Promise<void> {\n        this.log.debug('Set session');\n        if (auth.authCode == null) {\n            auth.authCode = this.options.authCode;\n        }\n        this.auth = auth;\n        if (!this.options.sessionStoreFilePath || !this.options.useAuthorizationCodeGrant) {\n            return;\n        }\n        this.log.debug(`Write session to file '${this.options.sessionStoreFilePath}'`);\n        await jsonfile.writeFile(this.options.sessionStoreFilePath, this.auth, { spaces: 2 });\n    }\n\n    private hasNewAuthCode(): boolean {\n        const hasNewAuthCode = this.auth?.authCode != this.options.authCode;\n        this.log.debug(`Has new auth code: ${hasNewAuthCode}`);\n        return hasNewAuthCode;\n    }\n\n    private setEmptySession(): void {\n        this.log.debug('Set empty session.');\n        this.auth = { authCode: this.options.authCode } as Session;\n    }\n\n    private isTokenExpired(): boolean {\n        const expired = (this.auth?.expires_at || 0) < Date.now() + this.options.renewBeforeExpiry;\n        this.log.debug('Is token expired: ' + expired);\n        return expired;\n    }\n\n    private hasAccessToken(): boolean {\n        const hasAccessToken = !!this.auth?.access_token;\n        this.log.debug('Has access token: ' + hasAccessToken);\n        return hasAccessToken;\n    }\n}\n"],
  "mappings": "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",
  "names": ["axios", "session", "jsonfile"]
}
